---
- name: Install Grafana on grafana server
  hosts: grafana
  become: yes
  
  tasks:
    - name: Install prerequisites
      apt:
        name:
          - apt-transport-https
          - software-properties-common
          - wget
          - gnupg
        state: present
        update_cache: yes
    
    - name: Download Grafana .deb package
      get_url:
        url: https://dl.grafana.com/oss/release/grafana_10.4.2_amd64.deb
        dest: /tmp/grafana.deb
        timeout: 60
    
    - name: Install Grafana from .deb file
      apt:
        deb: /tmp/grafana.deb
        state: present
    
    - name: Create datasources directory
      file:
        path: /etc/grafana/provisioning/datasources
        state: directory
        owner: root
        group: grafana
        mode: '0755'
    
    - name: Create dashboards directory
      file:
        path: /etc/grafana/provisioning/dashboards
        state: directory
        owner: root
        group: grafana
        mode: '0755'
    
    - name: Configure datasources (исправьте IP!)
      copy:
        content: |
          apiVersion: 1
          datasources:
            - name: Prometheus
              type: prometheus
              access: proxy
              url: http://10.0.1.19:9090  # ИСПРАВЬТЕ! 10.0.1.19 а не 10.0.1.12
              isDefault: true
        dest: /etc/grafana/provisioning/datasources/prometheus.yml
        owner: root
        group: grafana
        mode: '0644'
    
    - name: Set Grafana admin password
      ini_file:
        path: /etc/grafana/grafana.ini
        section: security
        option: admin_password
        value: "admin123"
        backup: yes
    
    - name: Enable and start Grafana
      systemd:
        name: grafana-server
        enabled: yes
        state: started
        daemon_reload: yes
    
    - name: Check Grafana status
      shell: |
        sleep 10
        curl -s -o /dev/null -w "%{http_code}\n" http://localhost:3000/api/health || echo "000"
      register: grafana_status
    
    - name: Show Grafana status
      debug:
        msg: "Grafana HTTP статус: {{ grafana_status.stdout }}"