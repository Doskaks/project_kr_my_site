# elasticsearch.yml
---
- name: Установка Elasticsearch в Docker
  hosts: elasticsearch
  become: yes
  
  tasks:
    - name: Обновить apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
    
    - name: Установить необходимые пакеты
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
          - software-properties-common
        state: present
    
    - name: Добавить GPG ключ Docker
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present
    
    - name: Добавить репозиторий Docker
      apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present
        update_cache: yes
    
    - name: Установить Docker
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
        state: present
    
    - name: Запустить и включить Docker
      systemd:
        name: docker
        state: started
        enabled: yes
    
    - name: Добавить пользователя в группу docker
      user:
        name: "{{ ansible_user }}"
        groups: docker
        append: yes
    
    - name: Установить docker-compose
      apt:
        name: docker-compose
        state: present
    
    - name: Создать директорию для данных Elasticsearch
      file:
        path: /var/lib/elasticsearch
        state: directory
        owner: "1000"
        group: "1000"
        mode: '0755'
    
    - name: Остановить старый контейнер Elasticsearch если есть
      shell: |
        sudo docker stop elasticsearch 2>/dev/null || true
        sudo docker rm elasticsearch 2>/dev/null || true
      args:
        warn: false
    
    - name: Скачать образ Elasticsearch
      shell: |
        sudo docker pull elasticsearch:7.17.13
      args:
        warn: false
    
    - name: Запустить Elasticsearch в Docker
      shell: |
        sudo docker run -d \
          --name elasticsearch \
          --restart unless-stopped \
          -p 9200:9200 \
          -p 9300:9300 \
          -e "discovery.type=single-node" \
          -e "ES_JAVA_OPTS=-Xms512m -Xmx512m" \
          -e "xpack.security.enabled=false" \
          -v /var/lib/elasticsearch:/usr/share/elasticsearch/data \
          elasticsearch:7.17.13
      args:
        warn: false
    
    - name: Подождать запуска Elasticsearch
      wait_for:
        port: 9200
        delay: 15
        timeout: 180
    
    - name: Проверить что Elasticsearch работает
      shell: |
        sleep 25
        curl -s http://localhost:9200 | grep cluster_name || echo "Ожидание..."
      register: es_check
      until: "'cluster_name' in es_check.stdout"
      retries: 8
      delay: 10
    
    - name: Показать результат проверки
      debug:
        msg: "Elasticsearch успешно запущен: {{ es_check.stdout }}"
    
    - name: Проверить статус кластера
      shell: |
        curl -s http://localhost:9200/_cluster/health | jq -r '.status' 2>/dev/null || echo "проверка..."
      register: cluster_status
      ignore_errors: yes
    
    - name: Показать статус кластера
      debug:
        msg: "Статус кластера Elasticsearch: {{ cluster_status.stdout }}"